# 学校数据管理指南

## 功能概述

本系统提供了两种方式来管理日本语语言学校数据：

1. **自动抓取**：从公开网站抓取学校信息并导出为 Excel
2. **手动上传**：维护本地 Excel 文件，一键上传更新到网站

## 一、自动抓取数据

### 使用方法

1. **安装依赖**（如果还没安装）：
   ```bash
   npm install
   ```

2. **运行抓取脚本**：
   ```bash
   npm run scrape:schools
   ```

3. **查看结果**：
   - 脚本会在 `data/` 目录下生成 Excel 文件
   - 文件名格式：`schools_YYYY-MM-DD.xlsx`
   - 文件包含从以下网站抓取的数据：
     - https://studyinjpn.com/ja/search
     - http://www.nihongliuxue.com/index.php?catid=23
     - http://www.liuxuewind.com/LanguageSchoolv2

### 注意事项

- 抓取脚本会根据实际网站 HTML 结构自动解析
- 如果网站结构变化，可能需要调整 `scripts/scrape-schools.ts` 中的选择器
- 抓取的数据会自动去重合并（根据学校名称）
- 建议定期运行抓取脚本以获取最新数据

## 二、手动维护 Excel 并上传

### 步骤 1：下载模板

1. 访问管理后台：`/zh-CN/admin/schools/upload`
2. 点击「下载模板」按钮
3. 保存 Excel 文件到本地

### 步骤 2：填写数据

打开 Excel 文件，按照以下规则填写：

#### 必填字段
- **中文名称**：学校的中文名称
- **日文名称**：学校的日文名称

#### 可选字段（建议填写）

**基本信息**
- 都道府县：如"东京都"、"大阪府"
- 城市：如"东京"、"大阪"
- 地址（日文）：完整地址
- 最近车站：最近的车站名称
- 步行分钟：从车站到学校的步行时间（数字）
- 官网：学校官网 URL
- 电话：联系电话
- 邮箱：联系邮箱
- 学校简介：学校的中文介绍

**统计数据**
- 创办年份：数字，如 2000
- 招生规模：总招生人数，如 300
- 平均班级人数：如 15
- 中国学生比例：百分比数字，如 30（表示 30%）
- JLPT N1通过率：百分比数字，如 40（表示 40%）
- JLPT N2通过率：百分比数字，如 75（表示 75%）
- 大学升学率：百分比数字，如 85（表示 85%）

**服务信息**
- 有宿舍：填写"是"或"否"
- 签证支持：填写"是"或"否"（默认为"是"）
- 打工支持：填写"是"或"否"

**课程信息**
- 入学时间：多个时间用逗号分隔，如"1月,4月,7月,10月"
- 课程时长：多个时长用逗号分隔，如"1年,1.5年,2年"

**媒体**
- 封面图片URL：学校封面图片的 URL

### 步骤 3：上传并导入

1. 在管理后台页面选择填写好的 Excel 文件
2. 点击「开始上传」
3. 等待处理完成，查看导入结果：
   - **新增成功**：新创建的学校数量
   - **更新成功**：已存在学校的更新数量
   - **失败**：导入失败的记录数量及错误详情

### 数据更新逻辑

- 系统会根据「中文名称」自动匹配学校
- 如果学校已存在，会更新所有字段
- 如果学校不存在，会创建新记录
- 空字段不会覆盖已有数据（更新时）

## 三、Excel 文件格式说明

### 列名对照表

| Excel 列名 | 数据库字段 | 类型 | 说明 |
|-----------|-----------|------|------|
| 中文名称 | nameZh | 文本 | 必填 |
| 日文名称 | nameJa | 文本 | 必填 |
| 都道府县 | prefecture | 文本 | 可选 |
| 城市 | city | 文本 | 可选 |
| 地址（日文） | addressJa | 文本 | 可选 |
| 最近车站 | nearestStation | 文本 | 可选 |
| 步行分钟 | walkingMinutes | 数字 | 可选 |
| 官网 | website | URL | 可选 |
| 电话 | phone | 文本 | 可选 |
| 邮箱 | email | 邮箱 | 可选 |
| 学校简介 | descriptionZh | 文本 | 可选 |
| 创办年份 | establishedYear | 数字 | 可选 |
| 招生规模 | totalCapacity | 数字 | 可选 |
| 平均班级人数 | classSizeAvg | 数字 | 可选 |
| 中国学生比例 | chineseRatio | 百分比 | 填写数字，如 30 表示 30% |
| JLPT N1通过率 | jlptN1PassRate | 百分比 | 填写数字，如 40 表示 40% |
| JLPT N2通过率 | jlptN2PassRate | 百分比 | 填写数字，如 75 表示 75% |
| 大学升学率 | universityAcceptanceRate | 百分比 | 填写数字，如 85 表示 85% |
| 有宿舍 | hasDormitory | 布尔 | 填写"是"或"否" |
| 签证支持 | hasVisaSupport | 布尔 | 填写"是"或"否" |
| 打工支持 | hasPartTimeSupport | 布尔 | 填写"是"或"否" |
| 入学时间 | enrollmentPeriods | 数组 | 用逗号分隔，如"1月,4月" |
| 课程时长 | courseDurations | 数组 | 用逗号分隔，如"1年,2年" |
| 封面图片URL | coverImage | URL | 可选 |

## 四、常见问题

### Q: 抓取脚本运行失败怎么办？
A: 
1. 检查网络连接
2. 确认网站是否可访问
3. 查看错误信息，可能需要更新选择器
4. 某些网站可能有反爬虫机制，需要调整请求头或添加延迟

### Q: 上传时提示"格式错误"？
A:
1. 确认文件是 .xlsx 或 .xls 格式
2. 检查第一行是否为列标题
3. 确认必填字段（中文名称、日文名称）已填写

### Q: 如何批量更新现有学校？
A:
1. 下载当前数据（可通过数据库导出）
2. 在 Excel 中修改需要更新的字段
3. 上传文件，系统会自动识别并更新

### Q: 百分比字段如何填写？
A:
- 填写数字即可，不需要加 % 符号
- 例如：30 表示 30%，0.5 表示 0.5%
- 系统会自动转换为小数（30 → 0.3）

### Q: 布尔字段如何填写？
A:
- 填写"是"表示 true
- 填写"否"表示 false
- 不填写或填写其他值会使用默认值

## 五、技术实现

### 文件结构

```
scripts/
  └── scrape-schools.ts          # 数据抓取脚本

src/
  ├── app/
  │   ├── api/
  │   │   └── admin/
  │   │       ├── upload-schools/      # 上传 API
  │   │       └── download-template/   # 模板下载 API
  │   └── [locale]/
  │       └── admin/
  │           └── schools/
  │               └── upload/          # 上传页面
  └── lib/
      └── db/
          └── schema/
              └── schools.ts          # 数据库结构
```

### API 端点

- `POST /api/admin/upload-schools` - 上传 Excel 文件
- `GET /api/admin/download-template` - 下载模板文件

### 依赖包

- `exceljs` - Excel 文件读写
- `cheerio` - HTML 解析（抓取用）
- `axios` - HTTP 请求（抓取用）

## 六、后续优化建议

1. **数据验证增强**：添加更严格的数据格式验证
2. **批量操作**：支持批量删除、批量发布等操作
3. **数据对比**：上传前对比现有数据，显示差异
4. **导入历史**：记录每次导入的历史记录
5. **数据导出**：支持导出当前数据库中的学校数据为 Excel
